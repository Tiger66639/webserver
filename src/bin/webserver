<?php

define('WEBSERVER_BASEDIR', __DIR__ . '/../');
define('WEBSERVER_AUTOLOADER', WEBSERVER_BASEDIR . '../vendor/autoload.php');

require WEBSERVER_AUTOLOADER;

// set current dir to base dir for relative dirs
chdir(WEBSERVER_BASEDIR);

// read in json configuration
//$mainConfiguration = new \TechDivision\WebServer\MainJsonConfiguration(WEBSERVER_BASEDIR . 'etc/webserver.json');
// read in xml configuration <- just comment this in to use xml configuration
//$mainConfiguration = new \TechDivision\WebServer\MainXmlConfiguration(WEBSERVER_BASEDIR . 'etc/webserver.xml');

// init server array
$servers = array();

// start servers
foreach ($mainConfiguration->getServerConfigs() as $serverConfig) {
    // get type definitions
    $serverType = $serverConfig->getType();
    $serverContextType = $serverConfig->getServerContextType();

    // init server context
    $serverContext = new $serverContextType();
    $serverContext->init($serverConfig);

    // init and start server
    $servers[] = new $serverType($serverContext);
}

// wait for servers
foreach ($servers as $server) {
    $server->join();
}