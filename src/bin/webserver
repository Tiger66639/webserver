<?php

// set globals to be set before using them
ini_set('auto_globals_jit', 0);

define('WEBSERVER_BASEDIR', __DIR__ . '/../');
define('WEBSERVER_AUTOLOADER', WEBSERVER_BASEDIR . '../vendor/autoload.php');

require WEBSERVER_AUTOLOADER;

// read in configuration
// $mainConfiguration = new \TechDivision\WebServer\MainJsonConfiguration(WEBSERVER_BASEDIR . 'etc/webserver.json');
$mainConfiguration = new \TechDivision\WebServer\MainXmlConfiguration(WEBSERVER_BASEDIR . 'etc/webserver.xml');

// init server array
$servers = array();

// start servers
foreach ($mainConfiguration->getServerConfigs() as $serverConfig) {
    // get type definitions
    $serverType = $serverConfig->getType();
    $serverContextType = $serverConfig->getServerContextType();

    // init server context
    $serverContext = new $serverContextType();
    $serverContext->init($serverConfig);

    // init and start server
    $servers[] = new $serverType($serverContext);
}

// wait for servers
foreach ($servers as $server) {
    $server->join();
}